<script>
// ====================
// JavaScript - لوحة التحكم
// ====================

document.addEventListener('DOMContentLoaded', function() {
    // التحقق من تسجيل الدخول
    const user = JSON.parse(sessionStorage.getItem('user') || localStorage.getItem('user') || 'null');
    if (!user) {
        window.location.href = '/';
        return;
    }
    
    loadProducts();
    setupSearchListeners();
    
    // تحديث اسم المستخدم في الواجهة لو تحب
    console.log('مرحباً', user.name);
});

// تحميل المنتجات من السيرفر
async function loadProducts() {
    try {
        const response = await fetch('/api/products');
        const products = await response.json();
        renderProducts(products);
    } catch (error) {
        console.error('Error loading products:', error);
        showNotification('خطأ في تحميل المنتجات', 'error');
    }
}

function renderProducts(products) {
    const grid = document.getElementById('productsGrid');
    const noProducts = document.getElementById('noProducts');
    
    if (products.length === 0) {
        grid.innerHTML = '';
        noProducts.classList.remove('hidden');
        return;
    }
    
    noProducts.classList.add('hidden');
    
    const currencySymbols = {
        'SAR': 'ر.س', 'USD': '$', 'EUR': '€', 'GBP': '£',
        'AED': 'د.إ', 'KWD': 'د.ك', 'QAR': 'ر.ق', 'BHD': 'د.ب',
        'OMR': 'ر.ع', 'JOD': 'د.أ', 'EGP': 'ج.م', 'SDG': 'ج.س',
        'SYP': 'ل.س', 'LBP': 'ل.ل', 'YER': 'ر.ي', 'MAD': 'د.م',
        'TND': 'د.ت', 'DZD': 'د.ج', 'LYD': 'د.ل', 'TRY': '₺'
    };
    
    const countryNames = {
        'sa': 'السعودية', 'ae': 'الإمارات', 'kw': 'الكويت',
        'qa': 'قطر', 'bh': 'البحرين', 'om': 'عمان',
        'eg': 'مصر', 'sd': 'السودان', 'jo': 'الأردن',
        'iq': 'العراق', 'sy': 'سوريا', 'lb': 'لبنان',
        'ye': 'اليمن', 'ma': 'المغرب', 'tn': 'تونس',
        'dz': 'الجزائر', 'ly': 'ليبيا', 'ps': 'فلسطين',
        'us': 'أمريكا', 'uk': 'بريطانيا', 'tr': 'تركيا',
        'other': 'دولة أخرى'
    };
    
    const categories = {
        'electronics': 'إلكترونيات', 'cars': 'سيارات',
        'fashion': 'أزياء', 'home': 'منزل',
        'sports': 'رياضة', 'books': 'كتب',
        'toys': 'ألعاب', 'beauty': 'صحة وجمال',
        'food': 'مواد غذائية', 'pets': 'حيوانات',
        'services': 'خدمات', 'other': 'أخرى'
    };
    
    grid.innerHTML = products.map((product, index) => `
        <div class="product-card" style="animation: fadeInUp 0.5s ease-out ${index * 0.1}s both">
            <div class="product-image">
                <img src="${product.image || 'https://via.placeholder.com/400x300?text=No+Image'}" alt="${product.name}">
                <span class="product-badge">${categories[product.category] || product.category}</span>
            </div>
            <div class="product-info">
                <h3 class="product-title">${product.name}</h3>
                <div class="product-meta">
                    <span><i class="fas fa-map-marker-alt"></i> ${countryNames[product.country] || product.country} - ${product.city}</span>
                </div>
                <div class="product-price">
                    ${product.price.toLocaleString()} ${currencySymbols[product.currency] || product.currency}
                </div>
                <div class="product-footer">
                    <div class="seller-info">
                        <div class="seller-avatar">${product.seller?.name ? product.seller.name[0].toUpperCase() : 'U'}</div>
                        <span class="seller-name">${product.seller?.name || 'مستخدم'}</span>
                    </div>
                    ${product.facebookLink ? `
                        <a href="${product.facebookLink}" target="_blank" class="contact-btn" onclick="event.stopPropagation()">
                            <i class="fab fa-facebook"></i> تواصل
                        </a>
                    ` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

// البحث والفلترة
function setupSearchListeners() {
    const searchInput = document.getElementById('searchInput');
    const countryFilter = document.getElementById('countryFilter');
    const cityFilter = document.getElementById('cityFilter');
    
    if (searchInput) {
        searchInput.addEventListener('input', debounce(filterProducts, 300));
    }
    if (countryFilter) {
        countryFilter.addEventListener('change', filterProducts);
    }
    if (cityFilter) {
        cityFilter.addEventListener('input', debounce(filterProducts, 300));
    }
}

async function filterProducts() {
    const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
    const country = document.getElementById('countryFilter')?.value || '';
    const city = document.getElementById('cityFilter')?.value.toLowerCase() || '';
    
    try {
        const response = await fetch('/api/products');
        let products = await response.json();
        
        if (searchTerm) {
            products = products.filter(p => 
                p.name.toLowerCase().includes(searchTerm) ||
                p.description?.toLowerCase().includes(searchTerm)
            );
        }
        if (country) {
            products = products.filter(p => p.country === country);
        }
        if (city) {
            products = products.filter(p => p.city.toLowerCase().includes(city));
        }
        
        renderProducts(products);
    } catch (error) {
        console.error('Error filtering products:', error);
    }
}

function filterBy(category) {
    document.querySelectorAll('.filter-chip').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    fetch('/api/products')
        .then(r => r.json())
        .then(products => {
            if (category !== 'all') {
                products = products.filter(p => p.category === category);
            }
            renderProducts(products);
        });
}

// القائمة المنسدلة
function toggleMenu() {
    document.getElementById('userMenu').classList.toggle('active');
}

document.addEventListener('click', function(e) {
    const menu = document.getElementById('userMenu');
    const menuBtn = document.querySelector('.menu-dots');
    if (menu && !menu.contains(e.target) && !menuBtn?.contains(e.target)) {
        menu.classList.remove('active');
    }
});

function showProfile() {
    const user = JSON.parse(sessionStorage.getItem('user') || localStorage.getItem('user') || '{}');
    showNotification(`مرحباً ${user.name || ''}!`, 'info');
}

function showHelp() {
    showNotification('مركز المساعدة قريباً!', 'info');
}

function logout() {
    localStorage.removeItem('user');
    sessionStorage.removeItem('user');
    showNotification('تم تسجيل الخروج بنجاح', 'success');
    setTimeout(() => window.location.href = '/', 1000);
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
    };
}

function showNotification(message, type = 'info') {
    const existing = document.querySelectorAll('.notification');
    existing.forEach(n => n.remove());
    
    const notification = document.createElement('div');
    const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle' };
    const colors = { success: '#10b981', error: '#ef4444', info: '#3b82f6' };
    
    notification.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
    notification.style.cssText = `
        position: fixed; top: 20px; left: 50%;
        transform: translateX(-50%) translateY(-100px);
        background: rgba(15, 23, 42, 0.95); color: white;
        padding: 16px 24px; border-radius: 12px;
        display: flex; align-items: center; gap: 12px;
        font-weight: 600; z-index: 10000;
        border: 1px solid ${colors[type]};
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        transition: transform 0.3s ease;
    `;
    notification.querySelector('i').style.color = colors[type];
    document.body.appendChild(notification);
    
    setTimeout(() => notification.style.transform = 'translateX(-50%) translateY(0)', 100);
    setTimeout(() => {
        notification.style.transform = 'translateX(-50%) translateY(-100px)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
  </script>
  
